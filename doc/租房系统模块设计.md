租房系统模块设计

### 权限管理

注册

登录

鉴权

### 1、 管理系统

#### 1.1、房间管理

==涉及表：room==

主要列出页面包含元素：

##### 房间表格

不同的tabs通过组别分割

**2楼** | 3楼

| 房间名                    | 房间状态                 | 最近账单日状态                             | 费用模板                            | 操作         |
| ------------------------- | ------------------------ | ------------------------------------------ | ----------------------------------- | ------------ |
| 203 [!]*(感叹号表有备注)* | 租用中*(移上显示用户名)* | 已结清[未结清]*（移上显示未结清账单日期）* | 通用房租\|通用电费\|通用水费 \|创建 | 修改 \| 删除 |

##### 创建房间按钮

点击按钮后弹出模态框，与修改按钮弹出的模态框一样，只是修改模态框有回显。

模态框内有选择费用模板的穿梭框，也有选择住户的下拉框，住户和房间是多对一关系。

租户与房屋状态时一个下拉框与checkbox，checkbox的值为空置中，选中状态时，下拉框不可用，否则下拉框必须选一个用户。

##### 创建备注按钮

点击按钮后弹出模态框，有层级关系下拉框，可以选择备注所在房间名，如不选择，可以在备注内容中以空格把房间名和内容分隔开，自动会判断房间名。

##### 清空、修改备注按钮：

显示在感叹号弹出框中

##### 费用模板提示信息：

鼠标移上费用模板有费用模板的提示。点击费用模板会跳转到费用模板管理页面



#### 1.2、房间组别管理

已有API：插入一个房间组别，查询一个房间组别，删除一个房间组别

==涉及表： room_group ,  room_to_room_group==

主要列出页面包含元素：

##### 房间组别表格

| 组别名称 | 组别类型 | 组别描述 | 房间数量 |            |
| -------- | -------- | -------- | -------- | ---------- |
| 2楼      | 住宅     |          | 10       | 修改\|删除 |

点击组别名称会跳转到**房间表格**页面。

##### 创建组别按钮

点击按钮后弹出模态框，与修改按钮弹出的模态框一样，只是修改模态框有回显，模态框内有穿梭框，可以选择对应的房间。组别与房间是多对多关系。



#### 1.3、人员管理

==涉及表：renter==

主要列出页面包含元素

##### 人员管理表格

| 住户姓名 | 性别 | 年龄 | 手机号码         | 家庭成员数 | 微信备注 | 所在房间 | 操作       |
| -------- | ---- | ---- | ---------------- | ---------- | -------- | -------- | ---------- |
| 张三     | 男   | 24岁 | 133\*\*\*\*\*421 | 3          | 204租客  | 203      | 修改\|删除 |

##### 创建人员按钮

创建与修改同模态框，模态框内有所属房间下拉框，1个人员最多只能对应1个房间



#### 1.4、费用模板管理

==涉及表：charge_template , charge_template_room==

##### 费用模板管理表格

| 费用模板名称 | 收费     | 应用房间数             | 备注     | 应用 | 操作       |
| ------------ | -------- | ---------------------- | -------- | ---- | ---------- |
| 通用房租     | 250元/月 | 30间(以上可现实房间名) | 共用房租 |      | 修改\|删除 |

##### 创建费用模板按钮

与修改费用模板一样

##### 删除

只是逻辑删除，但是会删除中间表的连接。



#### 1.5、账单管理

==涉及表：bill  ,  bill_set==

##### 账单管理多条件查询器

可以按**bill_set_date，bill_batch_num , pay_status ，房间名 , 房间组名** 进行查询。

##### 账单管理表格

| 账单集编码           | 账单集房间 | 账单集日期   | 包含账单数 | 账单集状态       | 操作       |
| -------------------- | ---------- | ------------ | ---------- | ---------------- | ---------- |
| r203d20190901n003s01 | 203        | 2019年9月1日 | 3条        | 2019年9月3日付完 | 修改\|删除 |
| r204d20190901n003s01 | 204        | 2019年9月1日 | 3条        | 未支付           | 修改\|删除 |

说明：

- 账单编码逻辑 : **r+房间名 + d + 账单日期 + n + 包含账单数量 + s + 4位随机数**
- 单击账单集记录，会出现具体账单的详情。
- 账单集状态由所有账单状态确定，所有账单都付款则显示xx年xx月xx日付完，一张账单都没支付过则显示未支付，否则显示"已支付xx比账单"
- 账单集和账单只能逻辑删除，且不能在这里新建，只能通过开票系统新建。
- 修改按钮可以修改账单集下所有账单的cover开头的字段的值。



### 开票系统

入住和退房管理

数据录入，可以网页，也可以Excel

数据校验

数据生成



如何判断一个chargeTemplate是否需要显示开单按键？

1. 按月：距离上一条bill开单超过17天
2. 按日：距离上次开单超过1天
3. 按年，距上次开单超过200天
4. 按度，距上次开单超过1天

#### bill的精确模式与整合模式

unit不为0，也就是不是按度收费的账单有两种收费模式

**精确模式：**bill严格按照所选时间与上一张bill的时间之差，计算两个时间之间的费用，费用可能为小数。退房时强制使用此模式

**智能模式:** bill会以bill_set时间为准，bill的覆盖终点时间前后移动15天，以刚好与上一张bill的时间刚好形成一个周期，使费用正好为周期的倍数。

而unit为0的账单，会以输入的日期为准

#### bill_set的两种开票日期

每个月的1号。

每个月的入住日。

如何判断一个bill_set能否开票？

当两种开票日期加起来，至少有1个bill满足开票条件，则一个bill_set

#### 用户需决定两个变量：

##### 1.开票日期

最接近的1号(默认)：如果当前日期为14日或之前，则是本月的1号，否则是下个月的1号。

当前日期：

入住当日：

##### 2.开票模式

精确模式

智能模式



#### 用户入住

当房间处于空置状态，可以点击入住。

入住可填入入住人，入住日期，租约时长，押金。插入基础账单。

基础账单的开始时间和开始度数是通过chargeTemplateRoomId最后一张bill决定的，要求最后一张bill的type必须为1或者2或不存在，如果最后一张bill是普通账单，则无法入住。

入住人（可新增），入住时间，租约时长，当前房间已设置的收费项目（无法编辑），押金，房间，从哪里知道本宿舍

入住后应自动把unit不为0的bill生成一条cover_when_end的bill，并且为无需处理



#### 编辑各项初始读数

情况一：在bill表中不存在最后一张此chargeTemplateRoomId账单情况下，默认时间是当前，默认处于激活状态。插入后，在bill表中写入一条用填入时间和degree填充了**cover_degree_end**和**cover_when_end**的记录。并把状态设为无需收款

情况二：在bill表中已经类型为1或2的bill的情况下，以最新的cover_when_end作为时间默认值，cover_degree_end作为读数默认值，默认处于无效状态，一旦插入成功，则以以前的最后一天的cover_when_end和cover_degree_end作为新的bill的cover_when_start和cover_degree_start，所以这种账单是有可能end比start小的。并把账单状态设为无需收款。



当房间处于租用中状态，可以点击退房和人员管理。

#### 退房

找到最后一张状态为**已审核、已生成、无需处理**的账单，给前端处理。

通过弹模态框设置搬出读数，且搬出度数cover_when_end)必须等于退房日期，插入bill与退房操作(renterMapper和billMapper)必须在同一个事务中。按日计费的bill也会自动把cover_when_end设置为退房日期，cover_when_start会是最后一次费用。每个template都生成一个status为1的bill，表示已保存，type为2，表示属于退房类账单。

如果此chargeTemplateRoomId已存在状态为0或者为1的账单，则将其删除，已退房账单为准。



### 费用预览样例

通用房租:  200 元 / 个月 * 1 个月 = 200 元

通用电费: 1.5 元 / 度 * 20 度 = 30 元

通用水费：2元 / 度 * 20 度 = 40 元

押金: 500 元

管理费: 10 元 / 个月 * 1 个月 = 10 元

合计： 200 + 30 + 40 +10 - 500 = -220 元



#### 账单生成的流程

1. 采集信息

   根据chargeTemplateRoomId找到最后一张账单，如果此账单晚的状态为**可保存**或**可收集**的账单，则显示已存在的这张账单，如此账单状态为"已生成、已审核、无需处理"，则判断是否满足开单条件，如满足，会显示可开单按钮，点击后自动生成一条新的账单，默认状态为**可采集**。新账单的对上一张账单id属性为母账单Id。如没找到此chargeTemplateRoomId对应的bill，说明是新生成的charTemplateRoom，会提示先通过房间管理页面设置初始度数。

2. 采集完成后点击保存，账单进入**已保存**状态，已保存状态的账单可以点击编辑，重新进入**可采集**状态，但**不可编辑**状态的账单无法重新进入**可采集**状态。生成账单的条件再加一个是有人住的基础上。

   - 按时间收费类的账单，也是要一起选。在点击保存后生成一条状态为已保存的账单，点击编辑时删除此状态为保存的账单。

3. 审核

   列出所有**已保存和不可编辑**的账单，当点击"通过审核"，则账单状态切换为**审核通过**，审核过程可以随意修改账单数值。一旦审核完成，只能通过改数据库来修改账单数值了。

4. 生成

   列出所有状态为**审核通过**的账单，可选择生成pdf，或发送短信，或发送邮件，或发送微信的方式来生成账单。当成功执行生成pdf等操作后，账单进入**已生成**状态。

所以，当搬出时，要清除所有状态为**可采集和已保存**的账单。用生成的type为搬出账单，status为已保存的账单代替。



#### 开票流程

- 进入开票页面，用户选择开票日期，默认日期是最近的1号，也能选择入住当天，以及当前日期，和自己输入的日期。
- 每个房间有两个checkbox，一个是**启用**，另一个是**独选**。都可以手动勾选，当一个房间的**启用**checkBox被勾选，房间进入激活状态，可以输入各个度数，也可以在点击检查按钮，检查度数是否正确，点击保存时，使用度数生成对应的bill。当启用checkBox不被勾选时，房间无法被激活，无法接受度数输入，也无法检查度数，无法保存。
- 当至少有一个房间点击了独选时，所有房间没被选中**独选**的房间都会进入非激活状态。如果一个房间又选中独选，又被选中启用，就没有房间能被处理了。
- 每当开票日期发生变化，都可以点击"智能开票"按钮，每个房间都会重新按一定的规律决定是否进入激活状态。
  - 无论开票日期是哪种，如果有一个或以上的chargeTemplateRoomId没找到最近一张bill，会进入非激活状态，并在页面提示先指定初始度数。
  - 无论开票日期是哪种，如果所有chargeTemplatedRoomId都有最近一张bill，且有至少一张bill的type为1，则会进入激活状态。
  - 无论开票日期是哪种，如果所有最近账单是已保存，则可以默认进入激活状态，但已保存状态的账单集无法被编辑，一旦点击"启用编辑"，会把数据库中的账单和账单集对应记录都删掉，而页面则可以编辑。type为2的账单，无法点击"启用编辑"。不存在最近账单一部分是已保存，一部分是已生成的情况。
  - 如果开票日期是最近的1号





### 查询系统

#### 详细表格：

多条件+排列查询bill表

#### 数据图表：

1. 总体房间/单组房间，各类型费用（如水费，电费，总计费用等）折线图，时间为横坐标
2. 各种待交费用，按多少，按总体，分组为单位排序柱状图，房间是横坐标
3. 各种应缴费用，按时间（如半年，一年，一个月），按数量排序柱状图，应用bill表的cover_degree_start等字段计算，房间是横坐标
4. 以时间为横坐标，以组为单位，显示各个月的入住率，入住数，退房数